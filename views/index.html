<style>
    .apps {
        font-family: monospace;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 16px;
    }
    .apps td {
        padding: 10px;
        border: dashed 2px #077;
    }
    .apps td:nth-child(1) {
        color: #070;
    }
    .apps td:nth-child(2) {
        color: #007;
    }
    .apps td:nth-child(3) {
        color: #770;
    }
    .apps td:nth-child(4) {
        color: #770;
    }
    .apps td:nth-child(5) {
        color: #707;
    }
</style>

{{ title}} - {{ welcomeMsg }}

<div id="app" />

<template id="template">
    <table class="apps">
        <tr>
            <td>Heroku Name</td>
            <td>App Name</td>
            <td>App Id</td>
            <td>Created At</td>
            <td>Updated At</td>
            <td>Region</td>
        </tr>
        <tr v-for="app in apps">
            <td>[[ app.herokuName ]]</td>
            <td>[[ app.name ]]</td>
            <td>[[ app.id ]]</td>
            <td>[[ app.created_at ]]</td>
            <td>[[ app.updated_at ]]</td>
            <td>[[ app.region.name ]]</td>
            <!--<td><pre>[[ app ]]</pre></td>-->
        </tr>
    </table>
</template>

<script src="/vue"></script>

<script>
    function get(endpoint){
        return new Promise(resolve=>{
            fetch(endpoint).then(resp => resp.json().then(json => {
                resolve(json)
            }))
        })
    }

    function post(endpoint, payload){
        return new Promise(resolve=>{
            fetch(endpoint, {
                method: "POST",
                body: JSON.stringify(payload),
                headers: {
                    "Content-Type": "application/json"
                }
            }).then(resp => resp.json().then(json => {
                resolve(json)
            }))
        })
    }
</script>

<script>
    document.title = "{{ title }}"

    const appConfig = {
        methods: {
            getApps(token){
                return new Promise(resolve => {
                    post("/apps", {token}).then(json => resolve(json))
                })
            },
            getAllTokens(){
                return new Promise(resolve => {
                    get("/getalltokens").then(json => resolve(json))
                })
            },
        },
        data() {
            return {
                apps: [],
                alltokens: {},
            }
        },
        mounted(){
            this.getAllTokens().then(alltokens => {
                this.alltokens = alltokens

                Promise.all(Object.keys(this.alltokens.tokensByToken).map(token => this.getApps(token))).then(appss => {
                    this.apps = appss.flat().map(app => {
                        return app
                    })
                })
            })
        },
        compilerOptions: {
            delimiters: ["[[", "]]"]
        },
        template: document.getElementById("template").innerHTML
    }

    const app = Vue.createApp(appConfig)

    app.mount('#app')

    const createdAt = {{ createdAt }}

    setInterval(()=>{
        get("/createdat").then(json => {
            if(json !== createdAt) document.location.reload()
        })
    }, 500)
</script>
