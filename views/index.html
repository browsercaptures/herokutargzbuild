<style>
  .apps {
    font-family: monospace;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 16px;
  }
  .apps td {
    padding: 10px;
    border: dashed 2px #077;
  }
  .apps td:nth-child(1) {
    color: #700;
    font-weight: bold;
  }
  .apps td:nth-child(2) {
    color: #070;
    font-weight: bold;
  }
  .apps td:nth-child(3) {
    color: #007;
  }
  .apps td:nth-child(4) {
    color: #770;
  }
  .apps td:nth-child(5) {
    color: #770;
  }
  .apps td:nth-child(6) {
    color: #707;
  }
  .tokens {
    font-family: monospace;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 16px;
  }
  .tokens td {
    padding: 10px;
    border: dashed 2px #077;
  }
  .tokens td:nth-child(1) {
    color: #700;
    font-weight: bold;
  }
</style>

{{ title}} - {{ welcomeMsg }}

<div id="app" />

<template id="template">
  <table class="tokens">
    <tr>
      <td>Heroku Name</td>
    </tr>
    <tr v-for="name in Object.keys(alltokens.tokensByName)">
      <td>[[ alltokens.namesByName[name] ]]</td>
      <td>
        <button v-on:click="createapp(alltokens.tokensByName[name])">
          Create
        </button>
      </td>
    </tr>
  </table>
  <table class="apps">
    <tr>
      <td>Heroku Name</td>
      <td>App Name</td>
      <td>App Id</td>
      <td>Created At</td>
      <td>Updated At</td>
      <td>Region</td>
    </tr>
    <tr
      v-for="app in apps"
      :style="`background-color: ${appbckgs[app.herokuIndex]};`"
    >
      <td>[[ app.herokuName ]]</td>
      <td>[[ app.name ]]</td>
      <td>[[ app.id ]]</td>
      <td>[[ app.created_at ]]</td>
      <td>[[ app.updated_at ]]</td>
      <td>[[ app.region.name ]]</td>
      <td><button v-on:click="delapp(app)">Delete</button></td>
      <!--<td><pre>[[ app ]]</pre></td>-->
    </tr>
  </table>
</template>

<script src="/vue"></script>

<script>
  function get(endpoint) {
    return new Promise((resolve) => {
      fetch(endpoint).then((resp) =>
        resp.json().then((json) => {
          resolve(json);
        })
      );
    });
  }

  function post(endpoint, payload) {
    return new Promise((resolve) => {
      fetch(endpoint, {
        method: "POST",
        body: JSON.stringify(payload),
        headers: {
          "Content-Type": "application/json",
        },
      }).then((resp) =>
        resp.json().then((json) => {
          resolve(json);
        })
      );
    });
  }
</script>

<script>
  document.title = "{{ title }}"

  const appConfig = {
      methods: {
          createApp(name, token){
              return new Promise(resolve => {
                  post("/createapp", {name, token}).then(json => resolve(json))
              })
          },
          createapp(token){
              const name = window.prompt("App Name", "createdummyapp")

              if(name){
                  this.createApp(name, token).then(result => {
                      console.log(result)

                      this.getAllApps().then(apps => {
                          this.apps = apps
                      })
                  })
              }
          },
          getAllTokens(){
              return new Promise(resolve => {
                  get("/getalltokens").then(json => resolve(json))
              })
          },
          getApps(token){
              return new Promise(resolve => {
                  post("/apps", {token}).then(json => resolve(json))
              })
          },
          getAllApps(){
              return new Promise(resolve => {
                  get("/allapps").then(json => resolve(json))
              })
          },
          delApp(name, token){
              return new Promise(resolve => {
                  post("/delapp", {name, token}).then(json => resolve(json))
              })
          },
          delapp(app){
              this.delApp(app.name, app.herokuToken).then(result => {
                  console.log(result)

                  this.getAllApps().then(apps => {
                      this.apps = apps
                  })
              })
          },
      },
      data() {
          return {
              apps: [],
              alltokens: {
                  tokensByName: {},
                  tokensByToken: {},
                  namesByName: {},
              },
              appbckgs: [
                  "#faa",
                  "#aea",
                  "#ccf",
                  "#eea",
                  "#f9f",
                  "#aee"
              ],
          }
      },
      mounted(){
          this.getAllApps().then(apps => {
              this.apps = apps
          })

          this.getAllTokens().then(alltokens => this.alltokens = alltokens)
      },
      compilerOptions: {
          delimiters: ["[[", "]]"]
      },
      template: document.getElementById("template").innerHTML
  }

  const app = Vue.createApp(appConfig)

  app.mount('#app')

  const createdAt = {{ createdAt }}

  setInterval(()=>{
      get("/createdat").then(json => {
          if(json !== createdAt) document.location.reload()
      })
  }, 500)
</script>
